<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oris • Criar conta</title>

  <!-- Mapbox GL -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- Mapbox Geocoder -->
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.min.js"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <style>
    :root{--brand:#3857ff;--bg:#0b1221;--card:#0f1830;--stroke:#1e2b55;--txt:#fff;--muted:#8aa0d6}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,Arial}
    .wrap{max-width:920px;margin:24px auto;padding:16px}
    #map{height:380px;border-radius:12px;overflow:hidden;border:1px solid var(--stroke)}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:16px;margin-top:16px}
    label{display:block;margin:12px 0 6px;color:#a9b6d9}
    input,button{width:100%;padding:12px;border-radius:10px;border:1px solid #2b3c70;background:#0b1221;color:#fff}
    button{cursor:pointer;border:1px solid var(--brand)}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .hint{color:var(--muted);font-size:.9rem}
    #geocoder{margin-bottom:10px}
  </style>
</head>
<body>
<div class="wrap">
  <h2>Crie sua conta</h2>

  <div id="map"></div>

  <div class="card">
    <div id="geocoder"></div>
    <p class="hint">Busque sua cidade/bairro ou clique no mapa. As coordenadas preenchidas são automáticas.</p>

    <label>Seu nome</label>
    <input id="displayName" placeholder="Ex.: Marcos A. (MACC)"/>

    <label>E-mail</label>
    <input id="email" type="email" placeholder="voce@exemplo.com"/>

    <label>Foto de perfil (quadrada de preferência)</label>
    <input id="avatarFile" type="file" accept="image/*"/>

    <div class="row2">
      <div>
        <label>Latitude</label>
        <input id="lat" readonly>
      </div>
      <div>
        <label>Longitude</label>
        <input id="lng" readonly>
      </div>
    </div>

    <button id="createBtn">Criar conta</button>
    <p id="status" class="hint"></p>
  </div>
</div>

<script>
  // ===== COLOQUE SUAS CHAVES =====
  const MAPBOX_TOKEN  = 'pk.eyJ1IjoibWFjYzE5ODIiLCJhIjoiY21lbTFpN2g3MG1zbzJrb2w2a3llcG9tNyJ9.5VFSnR0E-iAJusaKr7ntAg';
  const SUPABASE_URL  = 'https://sdwhuonmixijcnhhtxdj.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkd2h1b25taXhpamNuaGh0eGRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5OTg0NzUsImV4cCI6MjA3MTU3NDQ3NX0.5rGWZnSP6V2H4RmB1u4O60tocnzLN2Sg63aC2a_9LcY;

  // ===== MAPA + GEOCODER =====
  mapboxgl.accessToken = MAPBOX_TOKEN;
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v11',
    center: [-38.501, -12.971], // Salvador padrão
    zoom: 9
  });

  const geocoder = new MapboxGeocoder({
    accessToken: MAPBOX_TOKEN,
    mapboxgl: mapboxgl,
    marker: false, // usamos nosso próprio marcador
    language: 'pt-BR',
    placeholder: 'Buscar endereço, cidade ou ponto de interesse'
  });
  document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

  const latEl = document.getElementById('lat');
  const lngEl = document.getElementById('lng');

  let pickMarker = null;
  function setPoint(lngLat){
    latEl.value = (+lngLat.lat).toFixed(6);
    lngEl.value = (+lngLat.lng).toFixed(6);
    if(!pickMarker){
      pickMarker = new mapboxgl.Marker({color:'#3857ff'}).setLngLat(lngLat).addTo(map);
    } else {
      pickMarker.setLngLat(lngLat);
    }
  }

  map.on('click', (e)=> setPoint(e.lngLat));
  geocoder.on('result', (e)=>{
    const [lng,lat] = e.result.center;
    setPoint({lng,lat});
    map.flyTo({center:[lng,lat], zoom: 12});
  });

  // ===== SUPABASE =====
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  async function uploadAvatar(file){
    const ext  = (file.name.split('.').pop() || 'jpg').toLowerCase();
    const path = `avatar_${Date.now()}.${ext}`;
    const up = await sb.storage.from('avatars').upload(path, file, { cacheControl: '3600', upsert: false });
    if(up.error) throw up.error;
    const pub = sb.storage.from('avatars').getPublicUrl(path);
    return pub.data.publicUrl;
  }

  function isValidEmail(email){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  async function emailExists(email){
    const { data, error } = await sb.from('profiles').select('id').eq('email', email.toLowerCase()).maybeSingle();
    if(error && error.code !== 'PGRST116') console.warn(error); // PGRST116 = no rows
    return !!data;
  }

  document.getElementById('createBtn').addEventListener('click', async ()=>{
    const status = document.getElementById('status');
    status.textContent = 'Validando...';

    const name  = document.getElementById('displayName').value.trim();
    const email = document.getElementById('email').value.trim().toLowerCase();
    const lat   = parseFloat(latEl.value);
    const lng   = parseFloat(lngEl.value);
    const file  = document.getElementById('avatarFile').files[0];

    if(!name){ status.textContent = 'Informe seu nome.'; return; }
    if(!email || !isValidEmail(email)){ status.textContent = 'Informe um e-mail válido.'; return; }
    if(isNaN(lat) || isNaN(lng)){ status.textContent = 'Escolha sua localização no mapa ou na busca.'; return; }
    if(!file){ status.textContent = 'Selecione sua foto de perfil.'; return; }

    // checa duplicidade de email
    if(await emailExists(email)){
      status.textContent = 'Este e-mail já está cadastrado.';
      return;
    }

    try{
      status.textContent = 'Enviando avatar...';
      const avatarUrl = await uploadAvatar(file);

      status.textContent = 'Criando conta...';
      const ins = await sb.from('profiles').insert({
        display_name: name,
        email: email,
        avatar_url: avatarUrl,
        lat, lng
      }).select().single();

      if(ins.error) throw ins.error;

      // guarda o id local para outras telas (map/feed)
      localStorage.setItem('oris_profile_id', ins.data.id);

      status.textContent = 'Conta criada! Indo para o mapa...';
      setTimeout(()=> window.location.href = 'map.html', 700);
    }catch(err){
      console.error(err);
      status.textContent = 'Erro ao criar conta.';
    }
  });
</script>
</body>
</html>
