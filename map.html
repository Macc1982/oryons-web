 <!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oris • Mapa</title>

  <!-- Mapbox + Turf -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      --bg:#0b1221; --panel:#0f1830; --stroke:#1e2b55; --brand:#3857ff; --txt:#fff; --muted:#a9b6d9;
    }
    body{margin:0;background:var(--bg);color:var(--txt);font-fa…
[23:51, 10/01/2026] .: <!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oris • Mapa</title>

  <!-- Mapbox + Turf -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      --bg:#0b1221; --panel:#0f1830; --stroke:#1e2b55;
      --brand:#3857ff; --txt:#fff; --muted:#a9b6d9;
    }
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,Arial}
    #map{position:fixed;inset:0}
    .avatar-pin{
      width:44px;height:44px;border-radius:50%;overflow:hidden;
      border:2px solid #fff;box-shadow:0 0 0 2px var(--brand);background:#111
    }
    .avatar-pin img{width:100%;height:100%;object-fit:cover}
    .mapboxgl-popup-content{
      background:#0f1830;color:#fff;border:1px solid #1e2b55;border-radius:10px
    }
    .panel{
      position:fixed;right:16px;top:16px;width:320px;
      background:var(--panel);border:1px solid var(--stroke);
      border-radius:12px;padding:14px;z-index:10
    }
    .panel h3{margin:0 0 8px;font-size:18px}
    .row{display:grid;gap:10px}
    select,button{
      width:100%;padding:10px;border-radius:10px;
      border:1px solid var(--stroke);background:#0b1221;color:#fff
    }
    button{cursor:pointer;border-color:var(--brand)}
    .hint{color:var(--muted);font-size:.9rem;margin-top:6px}
  </style>
</head>

<body>
<div id="map"></div>

<div class="panel">
  <h3>Nova conexão</h3>
  <div class="row">
    <select id="fromSelect"><option value="">De (perfil A)</option></select>
    <select id="toSelect"><option value="">Para (perfil B)</option></select>
    <select id="relSelect">
      <option value="">Tipo de vínculo</option>
      <option value="work_meet">Trabalho</option>
      <option value="school">Escola</option>
      <option value="gym">Academia</option>
      <option value="relatives">Parentes</option>
      <option value="coworkers">Colegas</option>
      <option value="schoolmates">Colegas escola</option>
    </select>
    <button id="connectBtn">Conectar</button>
    <div id="status" class="hint"></div>
  </div>
</div>

<script>
/* ===== CHAVES ===== */
const MAPBOX_TOKEN = 'pk.eyJ1IjoibWFjYzE5ODIiLCJhIjoiY21rOGhzMzM5MTd3bzNrb3BnNXNncGZpMCJ9.YGmfVhj1c4kTiQ2P7LJkvA';
const SUPABASE_URL = 'https://sdwhuonmixijcnhhtxdj.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkd2h1b25taXhpamNuaGh0eGRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5OTg0NzUsImV4cCI6MjA3MTU3NDQ3NX0.5rGWZnSP6V2H4RmB1u4O60tocnzLN2Sg63aC2a_9LcY';

/* ===== CLIENT SUPABASE (CORRETO) ===== */
const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON
);

/* ===== AUTH GUARD ===== */
(async () => {
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) {
    window.location.href = 'signup.html';
  }
})();

/* ===== MAPA ===== */
mapboxgl.accessToken = MAPBOX_TOKEN;
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/dark-v11',
  center: [0, 10],
  zoom: 2
});

/* ===== CORES ===== */
const REL_COLORS = {
  work_meet:'#1f6fff', school:'#ffd21f', gym:'#29d17d',
  relatives:'#ff2d55', coworkers:'#ff8a1f', schoolmates:'#9aa0a6'
};

/* ===== MARKER ===== */
function addAvatarMarker(p){
  if (p.lat == null || p.lng == null) return;

  const el = document.createElement('div');
  el.className = 'avatar-pin';
  el.innerHTML = <img src="${p.avatar_url}">;

  new mapboxgl.Marker(el)
    .setLngLat([p.lng, p.lat])
    .setPopup(new mapboxgl.Popup().setHTML(<strong>${p.display_name}</strong>))
    .addTo(map);
}

/* ===== CURVA ===== */
function addCurve(a,b,color,id){
  const line = turf.greatCircle([a.lng,a.lat],[b.lng,b.lat],{npoints:100});
  const src = src-${id}, lyr = lyr-${id};
  map.addSource(src,{type:'geojson',data:line});
  map.addLayer({
    id:lyr,type:'line',source:src,
    paint:{'line-color':color,'line-width':2.5}
  });
}

/* ===== LOAD ===== */
let profiles=[], byId={};

async function loadAll(){
  const { data: profs } = await supabaseClient.from('profiles').select('*');
  profiles = profs || [];
  profiles.forEach(p=>{
    byId[p.id]=p;
    addAvatarMarker(p);
  });

  fillSelects();

  const { data: conns } = await supabaseClient.from('connections').select('*');
  conns?.forEach(c=>{
    const a=byId[c.from_profile], b=byId[c.to_profile];
    if(a&&b) addCurve(a,b,REL_COLORS[c.relation_type]||'#888',c.id);
  });
}

function fillSelects(){
  ['fromSelect','toSelect'].forEach(id=>{
    const sel=document.getElementById(id);
    sel.innerHTML='<option value="">Selecione</option>';
    profiles.forEach(p=>{
      const o=document.createElement('option');
      o.value=p.id; o.textContent=p.display_name;
      sel.appendChild(o);
    });
  });
}

/* ===== CONEXÃO ===== */
document.getElementById('connectBtn').onclick = async ()=>{
  const from=document.getElementById('fromSelect').value;
  const to=document.getElementById('toSelect').value;
  const rel=document.getElementById('relSelect').value;
  const status=document.getElementById('status');

  if(!from||!to||!rel||from===to){
    status.textContent='Dados inválidos.';
    return;
  }

  await supabaseClient.from('connections').insert({
    from_profile:from,to_profile:to,relation_type:rel
  });

  status.textContent='Conectado!';
};

map.on('load', loadAll);
</script>
</body>
</html>
