<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Feed • Seus Pontos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:,">
  <style>
    :root{ --bg:#0b1221; --card:#11182b; --text:#e6efff; --muted:#8ea3c7; --accent:#2638ff; }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px 18px;border-bottom:1px solid #ffffff1a}
    a.btn{background:var(--accent);color:#fff;text-decoration:none;padding:10px 14px;border-radius:10px;font-weight:600}
    main{max-width:980px;margin:0 auto;padding:20px;display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:var(--card);border:1px solid #ffffff1a;border-radius:12px;padding:14px}
    .card h3{margin:0 0 8px}
    .card img{width:100%;height:auto;border-radius:10px;margin:10px 0;border:1px solid #0003}
    .muted{color:var(--muted);font-size:13px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <strong>Seu feed</strong>
    <a class="btn" href="map.html">Adicionar pontos</a>
  </header>

  <main id="feed"><p class="muted">Carregando...</p></main>

  <script>
    const SUPABASE_URL = 'https://sdwhuonmixijcnhhtxdj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkd2h1b25taXhpamNuaGh0eGRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5OTg0NzUsImV4cCI6MjA3MTU3NDQ3NX0.5rGWZnSP6V2H4RmB1u4O60tocnzLN2Sg63aC2a_9LcY';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true } });

    async function carregar(){
      const { data: sess } = await supabase.auth.getSession();
      if (!sess.session && location.protocol !== 'file:') { location.href = 'login.html'; return; }
      const userId = sess.session?.user?.id || null;

      // ——— FEED DO USUÁRIO (retorna ARRAY; sem .single())
      const { data: rows, error } = await supabase
        .from('map_points')
        .select('*')
        .eq('user_id', userId)                 // remova esta linha para feed geral
        .order('created_at', { ascending: false });

      const list = document.getElementById('feed');
      if (error) { console.error(error); list.innerHTML = '<p class="muted">Erro ao carregar.</p>'; return; }
      if (!rows || !rows.length) { list.innerHTML = '<p class="muted">Sem pontos por enquanto.</p>'; return; }

      list.innerHTML = '';
      for (const row of rows) {
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML =
          '<h3>' + (row.title ?? '') + '</h3>' +
          (row.photo_url ? '<img src="'+ row.photo_url +'" alt="Foto do ponto">' : '') +
          (row.description ? '<p>'+ row.description +'</p>' : '') +
          '<p class="muted">' +
            (row.happened_at || '') +
            (row.lat && row.lng ? ' • ' + Number(row.lat).toFixed(5) + ', ' + Number(row.lng).toFixed(5) : '') +
          '</p>';
        list.appendChild(card);
      }
    }
    carregar();
  </script>
</body>
</html>
