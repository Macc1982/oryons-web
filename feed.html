<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Feed • Globo 3D</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b1221;
      --card:#0b1221;
      --accent:#2638ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#fff}
    .wrap{max-width:900px;margin:0 auto;padding:20px;min-height:100vh;display:flex;flex-direction:column;gap:20px}
    h1{margin:0;font-size:24px;font-weight:600}
    .nav{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
    .btn{padding:8px 12px;border:0;border-radius:8px;background:var(--accent);color:#fff;font-weight:600;text-decoration:none;display:inline-block}
    .btn-outline{background:#ffffff10;border:1px solid #ffffff30;color:#fff;text-decoration:none;padding:8px 12px;border-radius:8px}
    .muted{color:#8ea3c7;font-size:14px}
    .feed-list{display:flex;flex-direction:column;gap:16px}
    .item{border:1px solid #ffffff20;border-radius:12px;padding:16px;background:#0f192e}
    .item h3{margin:0 0 4px;font-size:18px;color:#fff}
    .item p{margin:6px 0;color:#cbd5e1;font-size:14px}
    .item img{display:block;max-width:100%;border-radius:8px;margin-top:8px}
    .meta{font-size:12px;color:#8ea3c7;margin-top:4px}
    .error{color:#e11d48;font-size:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <h1>Feed</h1>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn" href="map.html">Meus pontos</a>
        <button id="logoutBtn" class="btn-outline">Sair</button>
      </div>
    </div>
    <p class="muted">Veja os pontos que você marcou no mapa.</p>
    <div id="error" class="error" style="display:none"></div>
    <div id="feed" class="feed-list"></div>
  </div>

 <script>
const SUPABASE_URL = 'https://sdwhuonmixijcnhhtxdj.supabase.co';
const SUPABASE_ANON_KEY = '...sua key...';
const BUCKET_NAME = 'map-photos';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true } });

async function carregarFeed() {
  const { data: sess } = await supabase.auth.getSession();
  if (!sess.session) return location.href = 'login.html';

  const { data: rows, error } = await supabase
    .from('map_points')
    .select('*')
    .eq('user_id', sess.session.user.id)
    .order('created_at', { ascending: false });

  if (error) { console.error(error); return; }

  const list = document.getElementById('feed');
  list.innerHTML = '';

  for (const row of rows) {
    let imgUrl = null;
    if (row.photo_url) {
      const { data: signed, error: sErr } =
        await supabase
          .storage
          .from(BUCKET_NAME)
          .createSignedUrl(row.photo_url, 60 * 60); // 1h

      if (!sErr) imgUrl = signed.signedUrl;
    }

    const item = document.createElement('article');
    item.className = 'card';
    item.innerHTML = `
      <h3>${row.title ?? ''}</h3>
      ${imgUrl ? <img src="${imgUrl}" alt=""> : ''}
      <p>${row.description ?? ''}</p>
      <small>${row.happened_at ?? ''}</small>
    `;
    list.appendChild(item);
  }
}

carregarFeed();
</script>
</body>
</html>
